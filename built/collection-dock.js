//     collection-dock
//     (c)
//     collection-dock is licensed under the MIT terms.

/*!
 *
 * Copyright 2009-2012 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 * With parts by Tyler Close
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * With parts by Mark Miller
 * Copyright (C) 2011 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */

//     CollectionDock
//     (c)
//     CollectionDock is licensed under the MIT terms.

define("__collection-dock/attach/initialize",["require","exports","module","lodash"],function(e,t,n){var o=e("lodash");n.exports=function(){o.bindAll(this,"qExec","qExecSequence")}}),function(e){if("function"==typeof bootstrap)bootstrap("promise",e);else if("object"==typeof exports)module.exports=e();else if("function"==typeof define&&define.amd)define("q",e);else if("undefined"!=typeof ses){if(!ses.ok())return;ses.makeQ=e}else Q=e()}(function(){function e(e){return function(){return J.apply(e,arguments)}}function t(e){return e===Object(e)}function n(e){return"[object StopIteration]"===ot(e)||e instanceof L}function o(e,t){if(Q&&t.stack&&"object"==typeof e&&null!==e&&e.stack&&-1===e.stack.indexOf(it)){for(var n=[],o=t;o;o=o.source)o.stack&&n.unshift(o.stack);n.unshift(e.stack);var i=n.join("\n"+it+"\n");e.stack=r(i)}}function r(e){for(var t=e.split("\n"),n=[],o=0;o<t.length;++o){var r=t[o];u(r)||i(r)||!r||n.push(r)}return n.join("\n")}function i(e){return-1!==e.indexOf("(module.js:")||-1!==e.indexOf("(node.js:")}function c(e){var t=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(e);if(t)return[t[1],Number(t[2])];var n=/at ([^ ]+):(\d+):(?:\d+)$/.exec(e);if(n)return[n[1],Number(n[2])];var o=/.*@(.+):(\d+)$/.exec(e);return o?[o[1],Number(o[2])]:void 0}function u(e){var t=c(e);if(!t)return!1;var n=t[0],o=t[1];return n===V&&o>=W&&ft>=o}function s(){if(Q)try{throw new Error}catch(e){var t=e.stack.split("\n"),n=t[0].indexOf("@")>0?t[1]:t[2],o=c(n);if(!o)return;return V=o[0],o[1]}}function a(e,t,n){return function(){return"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn(t+" is deprecated, use "+n+" instead.",new Error("").stack),e.apply(e,arguments)}}function f(e){return m(e)?e:x(e)?T(e):E(e)}function p(){function e(e){t=e,i.source=e,X(n,function(t,n){H(function(){e.promiseDispatch.apply(e,n)})},void 0),n=void 0,o=void 0}var t,n=[],o=[],r=et(p.prototype),i=et(h.prototype);if(i.promiseDispatch=function(e,r,i){var c=K(arguments);n?(n.push(c),"when"===r&&i[1]&&o.push(i[1])):H(function(){t.promiseDispatch.apply(t,c)})},i.valueOf=function(){if(n)return i;var e=y(t);return m(e)&&(t=e),e},i.inspect=function(){return t?t.inspect():{state:"pending"}},f.longStackSupport&&Q)try{throw new Error}catch(c){i.stack=c.stack.substring(c.stack.indexOf("\n")+1)}return r.promise=i,r.resolve=function(n){t||e(f(n))},r.fulfill=function(n){t||e(E(n))},r.reject=function(n){t||e(S(n))},r.notify=function(e){t||X(o,function(t,n){H(function(){n(e)})},void 0)},r}function l(e){if("function"!=typeof e)throw new TypeError("resolver must be a function.");var t=p();try{e(t.resolve,t.reject,t.notify)}catch(n){t.reject(n)}return t.promise}function d(e){return l(function(t,n){for(var o=0,r=e.length;r>o;o++)f(e[o]).then(t,n)})}function h(e,t,n){void 0===t&&(t=function(e){return S(new Error("Promise does not support operation: "+e))}),void 0===n&&(n=function(){return{state:"unknown"}});var o=et(h.prototype);if(o.promiseDispatch=function(n,r,i){var c;try{c=e[r]?e[r].apply(o,i):t.call(o,r,i)}catch(u){c=S(u)}n&&n(c)},o.inspect=n,n){var r=n();"rejected"===r.state&&(o.exception=r.reason),o.valueOf=function(){var e=n();return"pending"===e.state||"rejected"===e.state?o:e.value}}return o}function v(e,t,n,o){return f(e).then(t,n,o)}function y(e){if(m(e)){var t=e.inspect();if("fulfilled"===t.state)return t.value}return e}function m(e){return t(e)&&"function"==typeof e.promiseDispatch&&"function"==typeof e.inspect}function x(e){return t(e)&&"function"==typeof e.then}function g(e){return m(e)&&"pending"===e.inspect().state}function k(e){return!m(e)||"fulfilled"===e.inspect().state}function b(e){return m(e)&&"rejected"===e.inspect().state}function j(){!st&&"undefined"!=typeof window&&window.console&&console.warn("[Q] Unhandled rejection reasons (should be empty):",ct),st=!0}function w(){for(var e=0;e<ct.length;e++){var t=ct[e];console.warn("Unhandled rejection reason:",t)}}function q(){ct.length=0,ut.length=0,st=!1,at||(at=!0,"undefined"!=typeof process&&process.on&&process.on("exit",w))}function R(e,t){at&&(ut.push(e),t&&"undefined"!=typeof t.stack?ct.push(t.stack):ct.push("(no stack) "+t),j())}function _(e){if(at){var t=Y(ut,e);-1!==t&&(ut.splice(t,1),ct.splice(t,1))}}function S(e){var t=h({when:function(t){return t&&_(this),t?t(e):this}},function(){return this},function(){return{state:"rejected",reason:e}});return R(t,e),t}function E(e){return h({when:function(){return e},get:function(t){return e[t]},set:function(t,n){e[t]=n},"delete":function(t){delete e[t]},post:function(t,n){return null===t||void 0===t?e.apply(void 0,n):e[t].apply(e,n)},apply:function(t,n){return e.apply(t,n)},keys:function(){return nt(e)}},void 0,function(){return{state:"fulfilled",value:e}})}function T(e){var t=p();return H(function(){try{e.then(t.resolve,t.reject,t.notify)}catch(n){t.reject(n)}}),t.promise}function O(e){return h({isDef:function(){}},function(t,n){return F(e,t,n)},function(){return f(e).inspect()})}function A(e,t,n){return f(e).spread(t,n)}function $(e){return function(){function t(e,t){var c;if(rt){try{c=o[e](t)}catch(u){return S(u)}return c.done?c.value:v(c.value,r,i)}try{c=o[e](t)}catch(u){return n(u)?u.value:S(u)}return v(c,r,i)}var o=e.apply(this,arguments),r=t.bind(t,"next"),i=t.bind(t,"throw");return r()}}function D(e){f.done(f.async(e)())}function N(e){throw new L(e)}function P(e){return function(){return A([this,C(arguments)],function(t,n){return e.apply(t,n)})}}function F(e,t,n){return f(e).dispatch(t,n)}function C(e){return v(e,function(e){var t=0,n=p();return X(e,function(o,r,i){var c;m(r)&&"fulfilled"===(c=r.inspect()).state?e[i]=c.value:(++t,v(r,function(o){e[i]=o,0===--t&&n.resolve(e)},n.reject,function(e){n.notify({index:i,value:e})}))},void 0),0===t&&n.resolve(e),n.promise})}function I(e){return v(e,function(e){return e=Z(e,f),v(C(Z(e,function(e){return v(e,G,G)})),function(){return e})})}function U(e){return f(e).allSettled()}function z(e,t){return f(e).then(void 0,void 0,t)}function M(e,t){return f(e).nodeify(t)}var Q=!1;try{throw new Error}catch(B){Q=!!B.stack}var V,L,W=s(),G=function(){},H=function(){function e(){for(;t.next;){t=t.next;var n=t.task;t.task=void 0;var r=t.domain;r&&(t.domain=void 0,r.enter());try{n()}catch(c){if(i)throw r&&r.exit(),setTimeout(e,0),r&&r.enter(),c;setTimeout(function(){throw c},0)}r&&r.exit()}o=!1}var t={task:void 0,next:null},n=t,o=!1,r=void 0,i=!1;if(H=function(e){n=n.next={task:e,domain:i&&process.domain,next:null},o||(o=!0,r())},"undefined"!=typeof process&&process.nextTick)i=!0,r=function(){process.nextTick(e)};else if("function"==typeof setImmediate)r="undefined"!=typeof window?setImmediate.bind(window,e):function(){setImmediate(e)};else if("undefined"!=typeof MessageChannel){var c=new MessageChannel;c.port1.onmessage=function(){r=u,c.port1.onmessage=e,e()};var u=function(){c.port2.postMessage(0)};r=function(){setTimeout(e,0),u()}}else r=function(){setTimeout(e,0)};return H}(),J=Function.call,K=e(Array.prototype.slice),X=e(Array.prototype.reduce||function(e,t){var n=0,o=this.length;if(1===arguments.length)for(;;){if(n in this){t=this[n++];break}if(++n>=o)throw new TypeError}for(;o>n;n++)n in this&&(t=e(t,this[n],n));return t}),Y=e(Array.prototype.indexOf||function(e){for(var t=0;t<this.length;t++)if(this[t]===e)return t;return-1}),Z=e(Array.prototype.map||function(e,t){var n=this,o=[];return X(n,function(r,i,c){o.push(e.call(t,i,c,n))},void 0),o}),et=Object.create||function(e){function t(){}return t.prototype=e,new t},tt=e(Object.prototype.hasOwnProperty),nt=Object.keys||function(e){var t=[];for(var n in e)tt(e,n)&&t.push(n);return t},ot=e(Object.prototype.toString);L="undefined"!=typeof ReturnValue?ReturnValue:function(e){this.value=e};var rt;try{new Function("(function* (){ yield 1; })"),rt=!0}catch(B){rt=!1}var it="From previous event:";f.resolve=f,f.nextTick=H,f.longStackSupport=!1,f.defer=p,p.prototype.makeNodeResolver=function(){var e=this;return function(t,n){t?e.reject(t):arguments.length>2?e.resolve(K(arguments,1)):e.resolve(n)}},f.promise=l,f.passByCopy=function(e){return e},h.prototype.passByCopy=function(){return this},f.join=function(e,t){return f(e).join(t)},h.prototype.join=function(e){return f([this,e]).spread(function(e,t){if(e===t)return e;throw new Error("Can't join: not the same: "+e+" "+t)})},f.race=d,h.prototype.race=function(){return this.then(f.race)},f.makePromise=h,h.prototype.toString=function(){return"[object Promise]"},h.prototype.then=function(e,t,n){function r(t){try{return"function"==typeof e?e(t):t}catch(n){return S(n)}}function i(e){if("function"==typeof t){o(e,u);try{return t(e)}catch(n){return S(n)}}return S(e)}function c(e){return"function"==typeof n?n(e):e}var u=this,s=p(),a=!1;return H(function(){u.promiseDispatch(function(e){a||(a=!0,s.resolve(r(e)))},"when",[function(e){a||(a=!0,s.resolve(i(e)))}])}),u.promiseDispatch(void 0,"when",[void 0,function(e){var t,n=!1;try{t=c(e)}catch(o){if(n=!0,!f.onerror)throw o;f.onerror(o)}n||s.notify(t)}]),s.promise},f.when=v,h.prototype.thenResolve=function(e){return this.then(function(){return e})},f.thenResolve=function(e,t){return f(e).thenResolve(t)},h.prototype.thenReject=function(e){return this.then(function(){throw e})},f.thenReject=function(e,t){return f(e).thenReject(t)},f.nearer=y,f.isPromise=m,f.isPromiseAlike=x,f.isPending=g,h.prototype.isPending=function(){return"pending"===this.inspect().state},f.isFulfilled=k,h.prototype.isFulfilled=function(){return"fulfilled"===this.inspect().state},f.isRejected=b,h.prototype.isRejected=function(){return"rejected"===this.inspect().state};var ct=[],ut=[],st=!1,at=!0;f.resetUnhandledRejections=q,f.getUnhandledReasons=function(){return ct.slice()},f.stopUnhandledRejectionTracking=function(){q(),"undefined"!=typeof process&&process.on&&process.removeListener("exit",w),at=!1},q(),f.reject=S,f.fulfill=E,f.master=O,f.spread=A,h.prototype.spread=function(e,t){return this.all().then(function(t){return e.apply(void 0,t)},t)},f.async=$,f.spawn=D,f["return"]=N,f.promised=P,f.dispatch=F,h.prototype.dispatch=function(e,t){var n=this,o=p();return H(function(){n.promiseDispatch(o.resolve,e,t)}),o.promise},f.get=function(e,t){return f(e).dispatch("get",[t])},h.prototype.get=function(e){return this.dispatch("get",[e])},f.set=function(e,t,n){return f(e).dispatch("set",[t,n])},h.prototype.set=function(e,t){return this.dispatch("set",[e,t])},f.del=f["delete"]=function(e,t){return f(e).dispatch("delete",[t])},h.prototype.del=h.prototype["delete"]=function(e){return this.dispatch("delete",[e])},f.mapply=f.post=function(e,t,n){return f(e).dispatch("post",[t,n])},h.prototype.mapply=h.prototype.post=function(e,t){return this.dispatch("post",[e,t])},f.send=f.mcall=f.invoke=function(e,t){return f(e).dispatch("post",[t,K(arguments,2)])},h.prototype.send=h.prototype.mcall=h.prototype.invoke=function(e){return this.dispatch("post",[e,K(arguments,1)])},f.fapply=function(e,t){return f(e).dispatch("apply",[void 0,t])},h.prototype.fapply=function(e){return this.dispatch("apply",[void 0,e])},f["try"]=f.fcall=function(e){return f(e).dispatch("apply",[void 0,K(arguments,1)])},h.prototype.fcall=function(){return this.dispatch("apply",[void 0,K(arguments)])},f.fbind=function(e){var t=f(e),n=K(arguments,1);return function(){return t.dispatch("apply",[this,n.concat(K(arguments))])}},h.prototype.fbind=function(){var e=this,t=K(arguments);return function(){return e.dispatch("apply",[this,t.concat(K(arguments))])}},f.keys=function(e){return f(e).dispatch("keys",[])},h.prototype.keys=function(){return this.dispatch("keys",[])},f.all=C,h.prototype.all=function(){return C(this)},f.allResolved=a(I,"allResolved","allSettled"),h.prototype.allResolved=function(){return I(this)},f.allSettled=U,h.prototype.allSettled=function(){return this.then(function(e){return C(Z(e,function(e){function t(){return e.inspect()}return e=f(e),e.then(t,t)}))})},f.fail=f["catch"]=function(e,t){return f(e).then(void 0,t)},h.prototype.fail=h.prototype["catch"]=function(e){return this.then(void 0,e)},f.progress=z,h.prototype.progress=function(e){return this.then(void 0,void 0,e)},f.fin=f["finally"]=function(e,t){return f(e)["finally"](t)},h.prototype.fin=h.prototype["finally"]=function(e){return e=f(e),this.then(function(t){return e.fcall().then(function(){return t})},function(t){return e.fcall().then(function(){throw t})})},f.done=function(e,t,n,o){return f(e).done(t,n,o)},h.prototype.done=function(e,t,n){var r=function(e){H(function(){if(o(e,i),!f.onerror)throw e;f.onerror(e)})},i=e||t||n?this.then(e,t,n):this;"object"==typeof process&&process&&process.domain&&(r=process.domain.bind(r)),i.then(void 0,r)},f.timeout=function(e,t,n){return f(e).timeout(t,n)},h.prototype.timeout=function(e,t){var n=p(),o=setTimeout(function(){n.reject(new Error(t||"Timed out after "+e+" ms"))},e);return this.then(function(e){clearTimeout(o),n.resolve(e)},function(e){clearTimeout(o),n.reject(e)},n.notify),n.promise},f.delay=function(e,t){return void 0===t&&(t=e,e=void 0),f(e).delay(t)},h.prototype.delay=function(e){return this.then(function(t){var n=p();return setTimeout(function(){n.resolve(t)},e),n.promise})},f.nfapply=function(e,t){return f(e).nfapply(t)},h.prototype.nfapply=function(e){var t=p(),n=K(e);return n.push(t.makeNodeResolver()),this.fapply(n).fail(t.reject),t.promise},f.nfcall=function(e){var t=K(arguments,1);return f(e).nfapply(t)},h.prototype.nfcall=function(){var e=K(arguments),t=p();return e.push(t.makeNodeResolver()),this.fapply(e).fail(t.reject),t.promise},f.nfbind=f.denodeify=function(e){var t=K(arguments,1);return function(){var n=t.concat(K(arguments)),o=p();return n.push(o.makeNodeResolver()),f(e).fapply(n).fail(o.reject),o.promise}},h.prototype.nfbind=h.prototype.denodeify=function(){var e=K(arguments);return e.unshift(this),f.denodeify.apply(void 0,e)},f.nbind=function(e,t){var n=K(arguments,2);return function(){function o(){return e.apply(t,arguments)}var r=n.concat(K(arguments)),i=p();return r.push(i.makeNodeResolver()),f(o).fapply(r).fail(i.reject),i.promise}},h.prototype.nbind=function(){var e=K(arguments,0);return e.unshift(this),f.nbind.apply(void 0,e)},f.nmapply=f.npost=function(e,t,n){return f(e).npost(t,n)},h.prototype.nmapply=h.prototype.npost=function(e,t){var n=K(t||[]),o=p();return n.push(o.makeNodeResolver()),this.dispatch("post",[e,n]).fail(o.reject),o.promise},f.nsend=f.nmcall=f.ninvoke=function(e,t){var n=K(arguments,2),o=p();return n.push(o.makeNodeResolver()),f(e).dispatch("post",[t,n]).fail(o.reject),o.promise},h.prototype.nsend=h.prototype.nmcall=h.prototype.ninvoke=function(e){var t=K(arguments,1),n=p();return t.push(n.makeNodeResolver()),this.dispatch("post",[e,t]).fail(n.reject),n.promise},f.nodeify=M,h.prototype.nodeify=function(e){return e?(this.then(function(t){H(function(){e(null,t)})},function(t){H(function(){e(t)})}),void 0):this};var ft=s();return f}),define("__collection-dock/attach/handle-add/index",["require","exports","module","lodash","q","jquery"],function(e,t,n){var o=(e("lodash"),e("q")),r=e("jquery");n.exports=function(e){var t=r(this.itemPlaceholder(e)).attr(this.elementTypeAttribute,"placeholder");this.place(e,t);var n=this;o.when(this.itemData(e)).then(this.itemTemplate).done(function(o){var i=r(o).attr(n.elementTypeAttribute,"item");n.qExecSequence(["beforeAdd","add","afterAdd"],[e,i,t])})}}),define("__collection-dock/attach/handle-remove/index",["require","exports","module"],function(e,t,n){n.exports=function(e){var t=this.retrieve$El(e);console.log(t),this.qExecSequence(["beforeRemove","remove","afterRemove"],[e,t])}}),define("__collection-dock/attach/handle-reset/index",["require","exports","module"],function(e,t,n){n.exports=function(e){this.qExecSequence(["beforeReset","reset","afterReset"],[e,this.$el])}}),define("__collection-dock/attach/handle-resort/index",["require","exports","module"],function(e,t,n){n.exports=function(e){this.qExecSequence(["beforeSort","sort","afterSort"],[e,this.$el])}}),define("__collection-dock/attach/item",["require","exports","module","lodash"],function(e,t){var n=e("lodash");t.itemPlaceholder=function(e){return'<li class="placeholder">placeholder for '+e.get("id")+"</li>"},t.itemData=function(e){return e.attributes},t.itemTemplate=function(e){return'<li id="'+e.id+'"> Item id: '+e.id+"</li>"},t.itemSelector=function(e){return"["+this.elementTypeAttribute+'="item"]:eq('+this.collection.indexOf(e)+")"},t.elementTypeAttribute="data-__collection-dock__-type",t.retrieve$El=function(e){var t;return t=n.isArray(e)?n.map(e,n.bind(function(e){return this.itemSelector(e)},this)).join(","):this.itemSelector(e),this.$el.find(t)}}),define("__collection-dock/attach/exec",["require","exports","module","lodash","q"],function(e,t){var n=e("lodash"),o=e("q");t.qExec=function(e,t){var r=this[e],i=n.isFunction(r)?r.apply(this,t):!0;return o(i)},t.qExecSequence=function(e,t){return e=n.map(e,n.bind(function(e){return n.partial(this.qExec,e,t)},this)),n.reduce(e,function(e,t){return e.then(t)},o(!0))}}),define("__collection-dock/attach/handle-add/actions",["require","exports","module","lodash","jquery"],function(e,t){e("lodash"),e("jquery");t.place=function(e,t){var n=this.collection.indexOf(e),o=this.$el.children().eq(n-1);o.length>0?o.after(t):this.$el.append(t)},t.beforeAdd=function(e,t,n){return t.css("opacity",0),n.css({opacity:0})},t.add=function(e,t,n){n.replaceWith(t)},t.afterAdd=function(e,t){return t.animate({opacity:1})}}),define("__collection-dock/attach/handle-remove/actions",["require","exports","module","lodash"],function(e,t){e("lodash");t.beforeRemove=function(e,t){return console.log("beforeRemove"),t.animate({opacity:0})},t.remove=function(e,t){console.log("remove"),t.remove()},t.afterRemove=function(){console.log("afterRemove")}}),define("__collection-dock/attach/handle-reset/actions",["require","exports","module","lodash","../handle-add/index"],function(e,t){var n=e("lodash"),o=e("../handle-add/index");t.beforeReset=function(){console.log("beforeReset")},t.reset=function(e,t){t.html(""),e.each(n.bind(o,this))},t.afterReset=function(){console.log("afterReset")}}),define("__collection-dock/attach/handle-resort/actions",["require","exports","module","lodash","../handle-reset/index"],function(e,t){var n=(e("lodash"),e("../handle-reset/index"));t.beforeSort=function(){console.log("beforeSort")},t.sort=function(e,t){n.call(this,e,t)},t.afterSort=function(){console.log("afterSort")}}),define("__collection-dock/attach/index",["require","exports","module","lodash","./handle-add/index","./handle-remove/index","./handle-reset/index","./handle-resort/index","./item","./exec","./handle-add/actions","./handle-remove/actions","./handle-reset/actions","./handle-resort/actions"],function(e,t){var n=e("lodash"),o=e("./handle-add/index"),r=e("./handle-remove/index"),i=e("./handle-reset/index"),c=e("./handle-resort/index");t.resortEvent="resort",t.attach=function(e){this.detach(),this.collection=e,e.on("add",n.bind(o,this)).on("remove",n.bind(r,this)).on("reset",n.bind(i,this)).on(this.resortEvent,n.bind(c)),i.call(this,e)},t.detach=function(){this.collection&&this.collection.off("add",void 0,this).off("remove",void 0,this).off("reset",void 0,this).off(this.resortEvent,void 0,this),this.$el.html("")},n.extend(t,e("./item")),n.extend(t,e("./exec")),n.extend(t,e("./handle-add/actions")),n.extend(t,e("./handle-remove/actions")),n.extend(t,e("./handle-reset/actions")),n.extend(t,e("./handle-resort/actions"))}),define("collection-dock",["require","exports","module","lodash","subject","./__collection-dock/attach/initialize","./__collection-dock/attach/index"],function(e,t,n){var o=(e("lodash"),e("subject")),r=e("./__collection-dock/attach/initialize"),i=n.exports=o(function(e){this.$el=e||this.$el,r.call(this)});i.proto(e("./__collection-dock/attach/index"))});